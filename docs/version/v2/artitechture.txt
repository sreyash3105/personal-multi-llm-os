# System Architecture â€” Local AI Operating System

This document explains the full architecture, module relationships, data flow, and execution pipeline for the system.

---

## ğŸ— High-Level Structure

User (Laptop/PC UI)
â†“
FastAPI Server (code_server.py)
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pipeline â”‚ Chat Systemâ”‚ Vision â”‚
â”‚ (coding) â”‚ (profiles) â”‚ (image AI) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
Storage Layer
â†“
Disk

yaml
Copy code

All features are **local and offline**. No cloud network calls.

---

## ğŸ”Œ Module Overview

| Module | Role |
|--------|------|
| `code_server.py` | Master router + endpoint definitions |
| `pipeline.py` | coder â†’ reviewer â†’ judge â†’ escalation logic |
| `vision_pipeline.py` | image processing + model routing |
| `chat_storage.py` | profiles / chats / messages on disk |
| `history.py` | rotating global history for dashboard |
| `config.py` | model registry + configuration flags |
| `prompts.py` | system prompts for all roles |
| `dashboard.py` | human-readable task log UI |
| `chat_ui.py` | WhatsApp-style multi-chat web app |

---

## ğŸ”„ Logical Components

### 1) Code pipeline
Goal: generate **final improved code**, not raw model output.

coder â†’ reviewer â†’ judge â†’ (optional escalate to reviewer) â†’ final answer

pgsql
Copy code

- Coder = fast generation
- Reviewer = slower but best-quality correction
- Judge = numeric confidence & conflict report â†’ log only

### 2) Chat system
Goal: preserve context across projects without contaminating memory.

Profile (client/project)
â””â”€â”€ Chat (topic/task)
â””â”€â”€ Messages

yaml
Copy code

Each level can override model choice.

### 3) Vision system
Goal: run **one-off image analysis inside chats**.

- Image is never stored permanently
- Thumbnail saved for UX
- Result is stored as normal text message

---

## ğŸ” Execution Flow by Feature

### A) Code workflow
UI â†’ /api/code â†’ pipeline.run_coder â†’ pipeline.run_reviewer â†’ pipeline.run_judge
â†’ history_logger â†’ dashboard
â†’ return code to UI

shell
Copy code

### B) Chat workflow
UI â†’ /api/chat â†’ chat_storage.append_message â†’ call_ollama(model)
â†’ append assistant message â†’ history_logger â†’ UI refresh

shell
Copy code

### C) Vision workflow
UI upload â†’ /api/chat/vision
â†’ run_vision(image_bytes + user_prompt)
â†’ append "[Image]" user msg + assistant summary
â†’ store thumbnail + record message
â†’ UI shows thumbnail above text

yaml
Copy code

---

## ğŸ—‚ Storage Layout (Filesystem)

history/
history_20250101_001.jsonl
history_20250101_002.jsonl
chats/
A/profile.json
A/chats/
a/chat.json
b/chat.json
B/profile.json
B/chats/
a/chat.json
thumbnails/
<profile>/<chat>/<timestamp>.jpg # optional for vision

yaml
Copy code

---

## ğŸ“¡ UI Routing

| Path | Purpose |
|------|---------|
| `/chat` | Full multi-profile, multi-chat workspace |
| `/dashboard` | Global task history view (coder + chat + vision) |

---

## ğŸ§± Module Dependencies

chat_ui â†’ code_server â†’ (pipeline, chat_storage, vision_pipeline, config, history, prompts)
dashboard â†’ code_server â†’ history
pipeline â†’ config, history, prompts
vision â†’ config, history, prompts
chat_storage â†’ config

yaml
Copy code

Decoupling:
- Chat system does NOT depend on code pipeline
- Vision system only plugs into chat layer
- UI uses API only, no direct storage access

---

## âš™ Design Principles

| Principle | Reason |
|----------|--------|
| Local-first | privacy, speed, no limits |
| No single "memory blob" | avoids context poisoning between projects |
| Everything logged | reproducibility |
| Override hierarchy | max control without reconfig |
| Replaceable vision & language models | longevity & model freedom |
| Zero cloud dependencies | portability |

---

## ğŸš¨ Failure Safety

| Area | Strategy |
|------|----------|
| History logging | never blocks API â€” in try/except |
| Judge JSON | if invalid â†’ safe fallback with parse error |
| Missing models | error raised with clear message |
| Vision disabled | endpoint returns 400 instead of crashing |
| Missing profiles/chats | auto-create when possible |

---

## ğŸ§± Performance Scaling

| Area | Current | Future upgrade |
|------|--------|----------------|
| Chat history persistence | local JSON | SQLite or DuckDB |
| Vision | single model | hybrid routing by task type |
| Code pipeline | sync | async queued jobs |
| UI | monolithic | dynamic components |

---

## ğŸ§© System Diagram

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chat UI â”‚â”€â”€â”€â”€â”€â–¶â”‚ code_serverâ”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚
â–¼ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ chat_storageâ”‚ â”‚ pipeline â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚
â–¼ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ vision â”‚ â”‚ history â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜